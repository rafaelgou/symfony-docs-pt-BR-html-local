<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Testes &mdash; Symfony2.4Docs 2.4 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Symfony2.4Docs 2.4 documentation" href="../index.html" />
    <link rel="up" title="Livro" href="index.html" />
    <link rel="next" title="Validação" href="validation.html" />
    <link rel="prev" title="Bancos de Dados e Doctrine" href="doctrine.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="validation.html" title="Validação"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="doctrine.html" title="Bancos de Dados e Doctrine"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Symfony2.4Docs 2.4 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Livro</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="testes">
<span id="index-0"></span><h1>Testes<a class="headerlink" href="#testes" title="Permalink to this headline">¶</a></h1>
<p>Sempre que você escrever uma nova linha de código, você também adiciona
potenciais novos bugs. Para construir aplicações melhores e mais confiáveis,
você deve testar seu código usando testes funcionais e unitários.</p>
<div class="section" id="o-framework-de-testes-phpunit">
<h2>O Framework de testes PHPUnit<a class="headerlink" href="#o-framework-de-testes-phpunit" title="Permalink to this headline">¶</a></h2>
<p>O Symfony2 se integra com uma biblioteca independente - chamada PHPUnit -
para dar a você um rico framework de testes. Esse capitulo não vai abranger
o PHPUnit propriamente dito, mas ele tem a sua excelente documentação <a class="reference external" href="http://www.phpunit.de/manual/3.5/en/">documentation</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">O Symfony2 funciona com o PHPUnit 3.5.11 ou posterior, embora a versão 3.6.4 é
necessária para testar o código do núcleo do Symfony.</p>
</div>
<p>Cada teste - quer seja teste unitário ou teste funcional - é uma classe PHP
que deve residir no sub-diretório  <cite>Tests/</cite> de seus bundles. Se você seguir
essa regra, você pode executar todos os testes da sua aplicação com o
seguinte comando:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># espefifique o diretório de configuração na linha de comando</span>
<span class="nv">$ </span>phpunit -c app/
</pre></div>
</div>
<p>A opção <tt class="docutils literal"><span class="pre">-c</span></tt> diz para o PHPUnit procurar no diretório <tt class="docutils literal"><span class="pre">app/</span></tt> por um
arquivo de configuração. Se você está curioso sobre as opções do PHPUnit,
dê uma olhada no arquivo <tt class="docutils literal"><span class="pre">app/phpunit.xml.dist</span></tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">O Code coverage pode ser gerado com a opção <tt class="docutils literal"><span class="pre">--coverage-html</span></tt>.</p>
</div>
</div>
<div class="section" id="testes-unitarios">
<span id="index-1"></span><h2>Testes Unitários<a class="headerlink" href="#testes-unitarios" title="Permalink to this headline">¶</a></h2>
<p>Um teste unitário é geralmente um teste de uma classe PHP especifica. Se
você quer testar o comportamento global da sua aplicação, veja a seção sobre
<a class="reference internal" href="#testes-funcionais">Testes Funcionais</a>.</p>
<p>Escrever testes unitários no Symfony2 não é nada diferente do que escrever um
teste unitário padrão do PHPUnit. Vamos supor que, por exemplo, você tem uma
classe <em>incrivelmente</em> simples chamada <tt class="docutils literal"><span class="pre">Calculator</span></tt> no diretório <tt class="docutils literal"><span class="pre">Utility/</span></tt>
do seu bundle:</p>
<div class="highlight-python"><div class="highlight"><pre>// src/Acme/DemoBundle/Utility/Calculator.php
namespace Acme\DemoBundle\Utility;

class Calculator
{
    public function add($a, $b)
    {
        return $a + $b;
    }
}
</pre></div>
</div>
<p>Para testar isso, crie um arquivo chamado <tt class="docutils literal"><span class="pre">CalculatorTest</span></tt> no diretório <tt class="docutils literal"><span class="pre">Tests/Utility</span></tt>
do seu bundle:</p>
<div class="highlight-python"><div class="highlight"><pre>// src/Acme/DemoBundle/Tests/Utility/CalculatorTest.php
namespace Acme\DemoBundle\Tests\Utility;

use Acme\DemoBundle\Utility\Calculator;

class CalculatorTest extends \PHPUnit_Framework_TestCase
{
    public function testAdd()
    {
        $calc = new Calculator();
        $result = $calc-&gt;add(30, 12);

        // assert that our calculator added the numbers correctly!
        $this-&gt;assertEquals(42, $result);
    }
}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Por convenção, o sub-diretório <tt class="docutils literal"><span class="pre">Tests/</span></tt> deve replicar o diretório do seu bundle.
Então, se você estiver testando uma classe no diretório <tt class="docutils literal"><span class="pre">Utility/</span></tt> do seu bundle,
coloque o teste no diretório <tt class="docutils literal"><span class="pre">Tests/Utility/</span></tt>.</p>
</div>
<p>Assim como na rua aplicação verdadeira - o autoloading é automaticamente habilitado
via o arquivo <tt class="docutils literal"><span class="pre">bootstrap.php.cache</span></tt> (como configurado por padrão no arquivo
<tt class="docutils literal"><span class="pre">phpunit.xml.dist</span></tt>).</p>
<p>Executar os testes para um determinado arquivo ou diretório também é muito fácil:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="c"># executa todos os testes no diretório Utility</span>
<span class="nv">$ </span>phpunit -c app src/Acme/DemoBundle/Tests/Utility/

<span class="c"># executa os testes para a classe Article</span>
<span class="nv">$ </span>phpunit -c app src/Acme/DemoBundle/Tests/Utility/CalculatorTest.php

<span class="c"># executa todos os testes para todo o Bundle</span>
<span class="nv">$ </span>phpunit -c app src/Acme/DemoBundle/
</pre></div>
</div>
</div>
<div class="section" id="testes-funcionais">
<span id="index-2"></span><h2>Testes Funcionais<a class="headerlink" href="#testes-funcionais" title="Permalink to this headline">¶</a></h2>
<p>Testes funcionais verificam a integração das diferentes camadas de uma aplicação
(do roteamento as views). Eles não são diferentes dos testes unitários levando
em consideração o PHPUnit, mas eles tem um fluxo bem especifico:</p>
<ul class="simple">
<li>Fazer uma requisição;</li>
<li>Testar a resposta;</li>
<li>Clicar em um link ou submeter um formulário;</li>
<li>Testar a resposta;</li>
<li>Repetir a operação.</li>
</ul>
<div class="section" id="seu-primeiro-teste-funcional">
<h3>Seu Primeiro Teste Funcional<a class="headerlink" href="#seu-primeiro-teste-funcional" title="Permalink to this headline">¶</a></h3>
<p>Testes funcionais são arquivos PHP simples que estão tipicamente no diretório
<tt class="docutils literal"><span class="pre">Tests/Controller</span></tt> do seu bundle. Se você quer testar as páginas controladas
pela  sua classe <tt class="docutils literal"><span class="pre">DemoController</span></tt>, inicie criando um novo arquivo <tt class="docutils literal"><span class="pre">DemoControllerTest.php</span></tt>
que extende a classe especial <tt class="docutils literal"><span class="pre">WebTestCase</span></tt>.</p>
<p>Por exemplo, o Symfony2 Standard Edition fornece um teste funcional simples para
o <tt class="docutils literal"><span class="pre">DemoController</span></tt> (<a class="reference external" href="https://github.com/symfony/symfony-standard/blob/master/src/Acme/DemoBundle/Tests/Controller/DemoControllerTest.php">DemoControllerTest</a>) descrito assim:</p>
<div class="highlight-python"><div class="highlight"><pre>// src/Acme/DemoBundle/Tests/Controller/DemoControllerTest.php
namespace Acme\DemoBundle\Tests\Controller;

use Symfony\Bundle\FrameworkBundle\Test\WebTestCase;

class DemoControllerTest extends WebTestCase
{
    public function testIndex()
    {
        $client = static::createClient();

        $crawler = $client-&gt;request(&#39;GET&#39;, &#39;/demo/hello/Fabien&#39;);

        $this-&gt;assertTrue($crawler-&gt;filter(&#39;html:contains(&quot;Hello Fabien&quot;)&#39;)-&gt;count() &gt; 0);
    }
}
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p>Para executar seus testes funcionais, a classe <tt class="docutils literal"><span class="pre">WebTestCase</span></tt> class
inicializa o kernel da sua aplicação. Na maioria dos casos, isso
acontece automaticamente. Entretando, se o seu kernel está em um diretório
diferente do padrão, você vai precisar modificar seu arquivo <tt class="docutils literal"><span class="pre">phpunit.xml.dist</span></tt>
para alterar a variável de ambiente <tt class="docutils literal"><span class="pre">KERNEL_DIR</span></tt> para o diretório do
seu kernel:</p>
<div class="last highlight-python"><div class="highlight"><pre>&lt;phpunit
    &lt;!-- ... --&gt;
    &lt;php&gt;
        &lt;server name=&quot;KERNEL_DIR&quot; value=&quot;/path/to/your/app/&quot; /&gt;
    &lt;/php&gt;
    &lt;!-- ... --&gt;
&lt;/phpunit&gt;
</pre></div>
</div>
</div>
<p>O método <tt class="docutils literal"><span class="pre">createClient()</span></tt> retorna um cliente, que é como um navegador que você
vai usar para navegar no seu site:</p>
<div class="highlight-python"><div class="highlight"><pre>$crawler = $client-&gt;request(&#39;GET&#39;, &#39;/demo/hello/Fabien&#39;);
</pre></div>
</div>
<p>O método <tt class="docutils literal"><span class="pre">request()</span></tt> (veja <a class="reference internal" href="#book-testing-request-method-sidebar"><em>mais sobre o método request</em></a>)
retorna um objeto <tt class="docutils literal"><a class="reference external" href="http://api.symfony.com/master/Symfony/Component/DomCrawler/Crawler.html" title="Symfony\Component\DomCrawler\Crawler"><span class="pre">Crawler</span></a></tt> que pode ser
usado para selecionar um elemento na Response, clicar em links, e submeter formulários.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">O Crawler só funciona se a resposta é um documento XML ou HTML.
Para pegar a resposta bruta, use <tt class="docutils literal"><span class="pre">$client-&gt;getResponse()-&gt;getContent()</span></tt>.</p>
</div>
<p>Clique em um link primeiramente selecionando-o com o Crawler usando uma expressão
XPath ou um seletor CSS, então use o Client para clicar nele. Por exemplo, o
segunte código acha todos os links com o texto <tt class="docutils literal"><span class="pre">Greet</span></tt>, então seleciona o
segundo, e então clica nele:</p>
<div class="highlight-python"><div class="highlight"><pre>$link = $crawler-&gt;filter(&#39;a:contains(&quot;Greet&quot;)&#39;)-&gt;eq(1)-&gt;link();

$crawler = $client-&gt;click($link);
</pre></div>
</div>
<p>Submeter um formulário é muito parecido, selecione um botão do formulário,
opcionalmente sobrescreva alguns valores do formulário, então submeta-o:</p>
<div class="highlight-python"><div class="highlight"><pre>$form = $crawler-&gt;selectButton(&#39;submit&#39;)-&gt;form();

// pega alguns valores
$form[&#39;name&#39;] = &#39;Lucas&#39;;
$form[&#39;form_name[subject]&#39;] = &#39;Hey there!&#39;;

// submete o formulário
$crawler = $client-&gt;submit($form);
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">O formulário também pode manipular uploads e tem métodos para preencher diferentes
tipos de campos (ex. <tt class="docutils literal"><span class="pre">select()</span></tt> e <tt class="docutils literal"><span class="pre">tick()</span></tt>). Para mais detalhers, veja a seção
<a href="#id1"><span class="problematic" id="id2">`Forms`_</span></a> abaixo.</p>
</div>
<p>Agora que você pode facilmente navegar pela sua aplicação, use as afirmações para
testar que ela realmente faz o que você espera que ela faça. Use o Crawler para
fazer afirmações no DOM:</p>
<div class="highlight-python"><div class="highlight"><pre>// Afirma que a resposta casa com um seletor informado
$this-&gt;assertTrue($crawler-&gt;filter(&#39;h1&#39;)-&gt;count() &gt; 0);
</pre></div>
</div>
<p>Ou, teste contra o conteúdo do Response diretamente se você só quer afirmar que
o conteudo contém algum texto ou se o Response não é um documento XML/HTML:</p>
<div class="highlight-python"><div class="highlight"><pre>$this-&gt;assertRegExp(&#39;/Hello Fabien/&#39;, $client-&gt;getResponse()-&gt;getContent());
</pre></div>
</div>
<div class="sidebar" id="book-testing-request-method-sidebar">
<p class="first sidebar-title">Mais sobre o método <tt class="docutils literal"><span class="pre">request()</span></tt>:</p>
<p>A assinatura completa do método <tt class="docutils literal"><span class="pre">request()</span></tt> é:</p>
<div class="highlight-python"><div class="highlight"><pre>request(
    $method,
    $uri,
    array $parameters = array(),
    array $files = array(),
    array $server = array(),
    $content = null,
    $changeHistory = true
)
</pre></div>
</div>
<p>O array <tt class="docutils literal"><span class="pre">server</span></tt> são valores brutos que você espera encontrar normalmente na
variável superglobal do PHP <a class="reference external" href="http://php.net/manual/en/reserved.variables.server.php">$_SERVER</a>. Por exemplo, para setar os cabeçalhos
HTTP <cite>Content-Type</cite> e <cite>Referer</cite>, você passará o seguinte:</p>
<div class="last highlight-python"><div class="highlight"><pre>$client-&gt;request(
    &#39;GET&#39;,
    &#39;/demo/hello/Fabien&#39;,
    array(),
    array(),
    array(
        &#39;CONTENT_TYPE&#39; =&gt; &#39;application/json&#39;,
        &#39;HTTP_REFERER&#39; =&gt; &#39;/foo/bar&#39;,
    )
);
</pre></div>
</div>
</div>
<span class="target" id="index-3"></span></div>
</div>
<div class="section" id="trabalhando-com-o-teste-client">
<span id="index-4"></span><h2>Trabalhando com o Teste Client<a class="headerlink" href="#trabalhando-com-o-teste-client" title="Permalink to this headline">¶</a></h2>
<p>O teste Client simula um cliente HTTP como um navegador e faz requisições na sua
aplicação Symfony2:</p>
<div class="highlight-python"><div class="highlight"><pre>$crawler = $client-&gt;request(&#39;GET&#39;, &#39;/hello/Fabien&#39;);
</pre></div>
</div>
<p>O método <tt class="docutils literal"><span class="pre">request()</span></tt> pega o método HTTP e a URL como argumentos e retorna uma
instancia de <tt class="docutils literal"><span class="pre">Crawler</span></tt>.</p>
<p>Utilize o Crawler para encontrar elementos DOM no Response. Esses elementos podem
então ser usados para clicar em links e submeter formulários:</p>
<div class="highlight-python"><div class="highlight"><pre>$link = $crawler-&gt;selectLink(&#39;Go elsewhere...&#39;)-&gt;link();
$crawler = $client-&gt;click($link);

$form = $crawler-&gt;selectButton(&#39;validate&#39;)-&gt;form();
$crawler = $client-&gt;submit($form, array(&#39;name&#39; =&gt; &#39;Fabien&#39;));
</pre></div>
</div>
<p>Os métodos <tt class="docutils literal"><span class="pre">click()</span></tt> e <tt class="docutils literal"><span class="pre">submit()</span></tt> retornam um objeto <tt class="docutils literal"><span class="pre">Crawler</span></tt>.
Esses métodos são a melhor maneira de navegar na sua aplicação por tomarem
conta de várias coisas para você, como detectar o método HTTP de um formulário
e dar para você uma ótima API para upload de arquivos.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Você vai aprende rmais sobre os objetos <tt class="docutils literal"><span class="pre">Link</span></tt> e <tt class="docutils literal"><span class="pre">Form</span></tt> na seção
<a class="reference internal" href="#book-testing-crawler"><em>Crawler</em></a> abaixo.</p>
</div>
<p>O método <tt class="docutils literal"><span class="pre">request</span></tt> pode também ser usado para simular submissões de formulários
diretamente ou fazer requisições mais complexas:</p>
<div class="highlight-python"><div class="highlight"><pre>// Submeter diretamente um formuário (mas utilizando o Crawler é mais fácil!)
$client-&gt;request(&#39;POST&#39;, &#39;/submit&#39;, array(&#39;name&#39; =&gt; &#39;Fabien&#39;));

// Submissão de formulário com um upload de arquivo
use Symfony\Component\HttpFoundation\File\UploadedFile;

$photo = new UploadedFile(
    &#39;/path/to/photo.jpg&#39;,
    &#39;photo.jpg&#39;,
    &#39;image/jpeg&#39;,
    123
);
// ou
$photo = array(
    &#39;tmp_name&#39; =&gt; &#39;/path/to/photo.jpg&#39;,
    &#39;name&#39; =&gt; &#39;photo.jpg&#39;,
    &#39;type&#39; =&gt; &#39;image/jpeg&#39;,
    &#39;size&#39; =&gt; 123,
    &#39;error&#39; =&gt; UPLOAD_ERR_OK
);
$client-&gt;request(
    &#39;POST&#39;,
    &#39;/submit&#39;,
    array(&#39;name&#39; =&gt; &#39;Fabien&#39;),
    array(&#39;photo&#39; =&gt; $photo)
);

// Executa uma requisição de DELETE e passa os cabeçalhos HTTP
$client-&gt;request(
    &#39;DELETE&#39;,
    &#39;/post/12&#39;,
    array(),
    array(),
    array(&#39;PHP_AUTH_USER&#39; =&gt; &#39;username&#39;, &#39;PHP_AUTH_PW&#39; =&gt; &#39;pa$$word&#39;)
);
</pre></div>
</div>
<p>Por último mas não menos importante, você pode forçar cara requisição para ser
executada em seu pŕoprio processo PHP para evitar qualquer efeito colateral quando
estiver trabalhando com vários clientes no mesmo script:</p>
<div class="highlight-python"><div class="highlight"><pre>$client-&gt;insulate();
</pre></div>
</div>
<div class="section" id="navegando">
<h3>Navegando<a class="headerlink" href="#navegando" title="Permalink to this headline">¶</a></h3>
<p>O Cliente suporta muitas operação que podem ser realizadas em um navegador real:</p>
<div class="highlight-python"><div class="highlight"><pre>$client-&gt;back();
$client-&gt;forward();
$client-&gt;reload();

// Limpa todos os cookies e histórico
$client-&gt;restart();
</pre></div>
</div>
</div>
<div class="section" id="acessando-objetos-internos">
<h3>Acessando Objetos Internos<a class="headerlink" href="#acessando-objetos-internos" title="Permalink to this headline">¶</a></h3>
<p>Se você usa o cliente para testar sua aplicação, você pode querer acessar os
objetos internos do cliente:</p>
<div class="highlight-python"><div class="highlight"><pre>$history   = $client-&gt;getHistory();
$cookieJar = $client-&gt;getCookieJar();
</pre></div>
</div>
<p>Você também pode pegar os objetos relacionados a requisição mais recente:</p>
<div class="highlight-python"><div class="highlight"><pre>$request  = $client-&gt;getRequest();
$response = $client-&gt;getResponse();
$crawler  = $client-&gt;getCrawler();
</pre></div>
</div>
<p>Se as suas requisição não são isoladas, você pode também acessar o <tt class="docutils literal"><span class="pre">Container</span></tt>
e o <tt class="docutils literal"><span class="pre">Kernel</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$container = $client-&gt;getContainer();
$kernel    = $client-&gt;getKernel();
</pre></div>
</div>
</div>
<div class="section" id="acessando-o-container">
<h3>Acessando o Container<a class="headerlink" href="#acessando-o-container" title="Permalink to this headline">¶</a></h3>
<p>É altamente recomendado que um teste funcional teste somente o Response. Mas
em circunstancias extremamente raras, você pode querer acessar algum objeto
interno para escrever afirmações. Nestes casos, você pode acessar o dependency
injection container:</p>
<div class="highlight-python"><div class="highlight"><pre>$container = $client-&gt;getContainer();
</pre></div>
</div>
<p>Esteja ciente que isso não funciona se você isolar o cliente ou se você usar
uma camada HTTP. Para ver a lista de serviços disponíves na sua aplicação, utilize
a task <tt class="docutils literal"><span class="pre">container:debug</span></tt>.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Se a informação que você precisa verificar está disponível no profiler, uso-o então</p>
</div>
</div>
<div class="section" id="acessando-dados-do-profiler">
<h3>Acessando dados do Profiler<a class="headerlink" href="#acessando-dados-do-profiler" title="Permalink to this headline">¶</a></h3>
<p>En cada requisição, o profiler do Symfony coleta e guarda uma grande quantidade de
dados sobre a manipulação interna de cada request. Por exemplo, o profiler pode ser
usado para verificar se uma determinada página executa menos consultas no banco
quando estiver carregando.</p>
<p>Para acessar o Profiler da última requisição, faço o seguinte:</p>
<div class="highlight-python"><div class="highlight"><pre>$profile = $client-&gt;getProfile();
</pre></div>
</div>
<p>Para detalhes especificos de como usar o profiler dentro de um teste, seja o artigo
<tt class="xref doc docutils literal"><span class="pre">/cookbook/testing/profiling</span></tt> do cookbook.</p>
</div>
<div class="section" id="redirecionamento">
<h3>Redirecionamento<a class="headerlink" href="#redirecionamento" title="Permalink to this headline">¶</a></h3>
<p>Quando uma requisição retornar uma redirecionamento como resposta, o cliente automaticamente
segue o redirecionamento. Se você quer examinar o Response antes do redirecionamento use o
método <tt class="docutils literal"><span class="pre">followRedirects()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$client-&gt;followRedirects(false);
</pre></div>
</div>
<p>Quando o cliente não segue os redirecionamentos, você pode forçar o redirecionamento com
o método <tt class="docutils literal"><span class="pre">followRedirect()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$crawler = $client-&gt;followRedirect();
</pre></div>
</div>
</div>
</div>
<div class="section" id="o-crawler">
<span id="book-testing-crawler"></span><span id="index-5"></span><h2>O Crawler<a class="headerlink" href="#o-crawler" title="Permalink to this headline">¶</a></h2>
<p>Uma instancia do Crawler é retornada cada vez que você faz uma requisição com o Client.
Ele permite que você examinar documentos HTML, selecionar nós, encontrar links e
formulários.</p>
<div class="section" id="examinando">
<h3>Examinando<a class="headerlink" href="#examinando" title="Permalink to this headline">¶</a></h3>
<p>Como o jQuery, o Crawler tem metodos para examinar o DOM de um documento HTML/XML.
Por exemplo, isso encontra todos os elementos <tt class="docutils literal"><span class="pre">input[type=submit]</span></tt>, seleciona o
último da página, e então seleciona o elemento imediatamente acima dele:</p>
<div class="highlight-python"><div class="highlight"><pre>$newCrawler = $crawler-&gt;filter(&#39;input[type=submit]&#39;)
    -&gt;last()
    -&gt;parents()
    -&gt;first()
;
</pre></div>
</div>
<p>Muitos outros métodos também estão disponíveis:</p>
<table border="1" class="docutils">
<colgroup>
<col width="32%" />
<col width="68%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Metodos</th>
<th class="head">Descrição</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">filter('h1.title')</span></tt></td>
<td>Nós que casam com o seletor CSS</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">filterXpath('h1')</span></tt></td>
<td>Nós que casam com a expressão XPath</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">eq(1)</span></tt></td>
<td>Nó para a posição especifica</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">first()</span></tt></td>
<td>Primeiro nó</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">last()</span></tt></td>
<td>Último nó</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">siblings()</span></tt></td>
<td>Irmãos</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">nextAll()</span></tt></td>
<td>Todos os irmãos posteriores</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">previousAll()</span></tt></td>
<td>Todos os irmãos anteriores</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">parents()</span></tt></td>
<td>Nós de um nivel superior</td>
</tr>
<tr class="row-odd"><td><tt class="docutils literal"><span class="pre">children()</span></tt></td>
<td>Filhos</td>
</tr>
<tr class="row-even"><td><tt class="docutils literal"><span class="pre">reduce($lambda)</span></tt></td>
<td>Nós que a função não retorne false</td>
</tr>
</tbody>
</table>
<p>Como cada um desses métodos retorna uma nova instância de <tt class="docutils literal"><span class="pre">Crawler</span></tt>, você pode
restringir os nós selecionados encadeando a chamada de métodos:</p>
<div class="highlight-python"><div class="highlight"><pre>$crawler
    -&gt;filter(&#39;h1&#39;)
    -&gt;reduce(function ($node, $i)
    {
        if (!$node-&gt;getAttribute(&#39;class&#39;)) {
            return false;
        }
    })
    -&gt;first();
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Utilize a função <tt class="docutils literal"><span class="pre">count()</span></tt> para pegar o número de nós armazenados no Crawler:
<tt class="docutils literal"><span class="pre">count($crawler)</span></tt></p>
</div>
</div>
<div class="section" id="extraindo-informacoes">
<h3>Extraindo Informações<a class="headerlink" href="#extraindo-informacoes" title="Permalink to this headline">¶</a></h3>
<p>O Crawler pode extrair informações dos nós:</p>
<div class="highlight-python"><div class="highlight"><pre>// Retornar o valor do atributo para o primeiro nó
$crawler-&gt;attr(&#39;class&#39;);

// Retorna o valor do nó para o primeiro nó
$crawler-&gt;text();

// Extrai um array de atributos para todos os nós (_text retorna o valor do nó)
// retorna um array para cara elemento no crawler, cara um com o valor e href
$info = $crawler-&gt;extract(array(&#39;_text&#39;, &#39;href&#39;));

// Executa a lambda para cada nó e retorna um array de resultados
$data = $crawler-&gt;each(function ($node, $i)
{
    return $node-&gt;attr(&#39;href&#39;);
});
</pre></div>
</div>
</div>
<div class="section" id="links">
<h3>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h3>
<p>Para selecionar links, você pode usar os métodos acima ou o conveniente atalho
<tt class="docutils literal"><span class="pre">selectLink()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$crawler-&gt;selectLink(&#39;Click here&#39;);
</pre></div>
</div>
<p>Isso seleciona todos os links que contém o texto, ou imagens que o atributo <tt class="docutils literal"><span class="pre">alt</span></tt>
contém o determinado texto. Como outros métodos de filtragem, esse retorna outro
objeto <tt class="docutils literal"><span class="pre">Crawler</span></tt>.</p>
<p>Uma vez selecionado um link, você pode ter acesso a um objeto especial <tt class="docutils literal"><span class="pre">Link</span></tt>,
que tem métodos especificos muito úties para links (como <tt class="docutils literal"><span class="pre">getMethod()</span></tt> e
<tt class="docutils literal"><span class="pre">getUri()</span></tt>). Para clicar no link, use o método do Client <tt class="docutils literal"><span class="pre">click()</span></tt> e passe
um objeto do tipo <tt class="docutils literal"><span class="pre">Link</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$link = $crawler-&gt;selectLink(&#39;Click here&#39;)-&gt;link();

$client-&gt;click($link);
</pre></div>
</div>
</div>
<div class="section" id="formularios">
<h3>Formulários<a class="headerlink" href="#formularios" title="Permalink to this headline">¶</a></h3>
<p>Assim como nos links, você seleciona o form com o método <tt class="docutils literal"><span class="pre">selectButton()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$buttonCrawlerNode = $crawler-&gt;selectButton(&#39;submit&#39;);
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note que selecionamos os botões do formulário e não os forms, pois o form pode
ter vários botões; se você usar a API para examinar, tenha em mente que você deve
procurar por um botão.</p>
</div>
<p>O método <tt class="docutils literal"><span class="pre">selectButton()</span></tt> pode selecionar tags <tt class="docutils literal"><span class="pre">button</span></tt> e submit tags <tt class="docutils literal"><span class="pre">input</span></tt>.
Ele usa diversas partes diferentes do botão para encontrá-los:</p>
<ul class="simple">
<li>O atributo <tt class="docutils literal"><span class="pre">value</span></tt>;</li>
<li>O atributo <tt class="docutils literal"><span class="pre">id</span></tt> ou <tt class="docutils literal"><span class="pre">alt</span></tt> para imagens;</li>
<li>O valor do atributo <tt class="docutils literal"><span class="pre">id</span></tt> ou <tt class="docutils literal"><span class="pre">name</span></tt> para tags <tt class="docutils literal"><span class="pre">button</span></tt>.</li>
</ul>
<p>Uma vez que você tenha o Crawler representanto um botão, chame o método <tt class="docutils literal"><span class="pre">form()</span></tt>
para pegar a instancia de <tt class="docutils literal"><span class="pre">Form</span></tt> do form que envolve o nó do botão:</p>
<div class="highlight-python"><div class="highlight"><pre>$form = $buttonCrawlerNode-&gt;form();
</pre></div>
</div>
<p>Quando chamar o método <tt class="docutils literal"><span class="pre">form()</span></tt>, você pode também passar uma array com valores
dos campos para sobreescrever os valores padrões:</p>
<div class="highlight-python"><div class="highlight"><pre>$form = $buttonCrawlerNode-&gt;form(array(
    &#39;name&#39;              =&gt; &#39;Fabien&#39;,
    &#39;my_form[subject]&#39;  =&gt; &#39;Symfony rocks!&#39;,
));
</pre></div>
</div>
<p>E se você quiser simular algum método HTTP especifico para o form, passe-o como um
segundo argumento:</p>
<div class="highlight-python"><div class="highlight"><pre>$form = $crawler-&gt;form(array(), &#39;DELETE&#39;);
</pre></div>
</div>
<p>O Client pode submeter instancias de <tt class="docutils literal"><span class="pre">Form</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$client-&gt;submit($form);
</pre></div>
</div>
<p>Os valores dos campos também posem ser passsados como um segundo argumento do
método <tt class="docutils literal"><span class="pre">submit()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$client-&gt;submit($form, array(
    &#39;name&#39;              =&gt; &#39;Fabien&#39;,
    &#39;my_form[subject]&#39;  =&gt; &#39;Symfony rocks!&#39;,
));
</pre></div>
</div>
<p>Para situações mais complexas, use a instancia de <tt class="docutils literal"><span class="pre">Form</span></tt> como um array para
setar o valor de cada campo individualmente:</p>
<div class="highlight-python"><div class="highlight"><pre>// Muda o valor do campo
$form[&#39;name&#39;] = &#39;Fabien&#39;;
$form[&#39;my_form[subject]&#39;] = &#39;Symfony rocks!&#39;;
</pre></div>
</div>
<p>Também existe uma API para manipular os valores do campo de acordo com o seu tipo:</p>
<div class="highlight-python"><div class="highlight"><pre>// Seleciona um option ou um radio
$form[&#39;country&#39;]-&gt;select(&#39;France&#39;);

// Marca um checkbox
$form[&#39;like_symfony&#39;]-&gt;tick();

// Faz o upload de um arquivo
$form[&#39;photo&#39;]-&gt;upload(&#39;/path/to/lucas.jpg&#39;);
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Você pode pegar os valores que serão submetidos chamando o método <tt class="docutils literal"><span class="pre">getValues()</span></tt>
no objeto <tt class="docutils literal"><span class="pre">Form</span></tt>. Os arquivos do upload estão disponiveis em um array
separado retornado por <tt class="docutils literal"><span class="pre">getFiles()</span></tt>. Os métodos <tt class="docutils literal"><span class="pre">getPhpValues()</span></tt> e
<tt class="docutils literal"><span class="pre">getPhpFiles()</span></tt> também retorna valores submetidos, mas no formato
PHP (ele converte as chaves para a notação de colchetes - ex.
<tt class="docutils literal"><span class="pre">my_form[subject]</span></tt> - para PHP arrays).</p>
</div>
</div>
</div>
<div class="section" id="configuracao-de-testes">
<span id="index-6"></span><h2>Configuração de Testes<a class="headerlink" href="#configuracao-de-testes" title="Permalink to this headline">¶</a></h2>
<p>O Client usado pelos testes funcionais cria um Kernel que roda em um ambiente
especial chamado <tt class="docutils literal"><span class="pre">test</span></tt>. Uma vez que o Symfony carrega o <tt class="docutils literal"><span class="pre">app/config/config_test.yml</span></tt>
no ambiente <tt class="docutils literal"><span class="pre">test</span></tt>, você pode ajustar qualquer configuração de sua aplicação
especificamente para testes.</p>
<p>Por exemplo, por padrão, o swiftmailer é configurado para <em>não</em> enviar realmente
os e-mails no ambiente <tt class="docutils literal"><span class="pre">test</span></tt>. Você pode ver isso na opção de configuração
<tt class="docutils literal"><span class="pre">swiftmailer</span></tt>:</p>
<div class="configuration-block">
<ul class="simple">
<li><em>YAML</em><div class="highlight-yaml"><div class="highlight"><pre><span class="c1"># app/config/config_test.yml</span>
<span class="c1"># ...</span>

<span class="l-Scalar-Plain">swiftmailer</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">disable_delivery</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</pre></div>
</div>
</li>
<li><em>XML</em><div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- app/config/config_test.xml --&gt;</span>
<span class="nt">&lt;container&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>

    <span class="nt">&lt;swiftmailer:config</span> <span class="na">disable-delivery=</span><span class="s">&quot;true&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/container&gt;</span>
</pre></div>
</div>
</li>
<li><em>PHP</em><div class="highlight-php"><div class="highlight"><pre><span class="c1">// app/config/config_test.php</span>
<span class="c1">// ...</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="na">loadFromExtension</span><span class="p">(</span><span class="s1">&#39;swiftmailer&#39;</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">&#39;disable_delivery&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span>
<span class="p">));</span>
</pre></div>
</div>
</li>
</ul>
</div>
<p>Você também pode usar um ambiente completamente diferente, ou sobrescrever
o modo de debug (<tt class="docutils literal"><span class="pre">true</span></tt>) passando cada um como uma opção para o método
<tt class="docutils literal"><span class="pre">createClient()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$client = static::createClient(array(
    &#39;environment&#39; =&gt; &#39;my_test_env&#39;,
    &#39;debug&#39;       =&gt; false,
));
</pre></div>
</div>
<p>Se a sua aplicação se comporta de acordo com alguns cabeçalhos HTTP, passe eles
como o segundo argumento de <tt class="docutils literal"><span class="pre">createClient()</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>$client = static::createClient(array(), array(
    &#39;HTTP_HOST&#39;       =&gt; &#39;en.example.com&#39;,
    &#39;HTTP_USER_AGENT&#39; =&gt; &#39;MySuperBrowser/1.0&#39;,
));
</pre></div>
</div>
<p>Você também pode sobrescrever cabeçalhos HTTP numa base por requisições:</p>
<div class="highlight-python"><div class="highlight"><pre>$client-&gt;request(&#39;GET&#39;, &#39;/&#39;, array(), array(), array(
    &#39;HTTP_HOST&#39;       =&gt; &#39;en.example.com&#39;,
    &#39;HTTP_USER_AGENT&#39; =&gt; &#39;MySuperBrowser/1.0&#39;,
));
</pre></div>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">O cliente de testes está disponível como um serviço no container no ambiente
<tt class="docutils literal"><span class="pre">teste</span></tt> (ou em qualquer lugar que a opção <em class="xref std std-ref">framework.test</em>
esteja habilitada). Isso significa que você pode sobrescrever o serviço inteiramente
se você precisar.</p>
</div>
<div class="section" id="configuracao-do-phpunit">
<span id="index-7"></span><h3>Configuração do PHPUnit<a class="headerlink" href="#configuracao-do-phpunit" title="Permalink to this headline">¶</a></h3>
<p>Cada aplicação tem a sua própria configuração do PHPUnit, armazenada no arquivo
<tt class="docutils literal"><span class="pre">phpunit.xml.dist</span></tt>. Você pode editar o arquivo para mudar os valores padrões
ou criar um arquivo <tt class="docutils literal"><span class="pre">phpunit.xml`</span></tt> para ajustar a configuração para sua máquina
local.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Armazene o arquivo <tt class="docutils literal"><span class="pre">phpunit.xml.dist</span></tt> no seu repositório de códigos e ignore
o arquivo <tt class="docutils literal"><span class="pre">phpunit.xml</span></tt>.</p>
</div>
<p>Por padrão, somente os testes armazenados nos bundles &#8220;standard&#8221; são rodados
pelo comando <tt class="docutils literal"><span class="pre">phpunit</span></tt> (standard sendo os testes nos diretórios <tt class="docutils literal"><span class="pre">src/*/Bundle/Tests</span></tt> ou
<tt class="docutils literal"><span class="pre">src/*/Bundle/*Bundle/Tests</span></tt>) Mas você pode facilmente adicionar mais diretórios.
Por exemplo, a seguinte configuração adiciona os testes de um bundle de terceiros
instalado:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="c">&lt;!-- hello/phpunit.xml.dist --&gt;</span>
<span class="nt">&lt;testsuites&gt;</span>
    <span class="nt">&lt;testsuite</span> <span class="na">name=</span><span class="s">&quot;Project Test Suite&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;directory&gt;</span>../src/*/*Bundle/Tests<span class="nt">&lt;/directory&gt;</span>
        <span class="nt">&lt;directory&gt;</span>../src/Acme/Bundle/*Bundle/Tests<span class="nt">&lt;/directory&gt;</span>
    <span class="nt">&lt;/testsuite&gt;</span>
<span class="nt">&lt;/testsuites&gt;</span>
</pre></div>
</div>
<p>Para incluir outros diretórios no code coverage, edite também a sessção <tt class="docutils literal"><span class="pre">&lt;filter&gt;</span></tt>:</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;whitelist&gt;</span>
        <span class="nt">&lt;directory&gt;</span>../src<span class="nt">&lt;/directory&gt;</span>
        <span class="nt">&lt;exclude&gt;</span>
            <span class="nt">&lt;directory&gt;</span>../src/*/*Bundle/Resources<span class="nt">&lt;/directory&gt;</span>
            <span class="nt">&lt;directory&gt;</span>../src/*/*Bundle/Tests<span class="nt">&lt;/directory&gt;</span>
            <span class="nt">&lt;directory&gt;</span>../src/Acme/Bundle/*Bundle/Resources<span class="nt">&lt;/directory&gt;</span>
            <span class="nt">&lt;directory&gt;</span>../src/Acme/Bundle/*Bundle/Tests<span class="nt">&lt;/directory&gt;</span>
        <span class="nt">&lt;/exclude&gt;</span>
    <span class="nt">&lt;/whitelist&gt;</span>
<span class="nt">&lt;/filter&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="aprenda-mais-no-cookbook">
<h2>Aprenda mais no Cookbook<a class="headerlink" href="#aprenda-mais-no-cookbook" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><tt class="xref doc docutils literal"><span class="pre">/cookbook/testing/http_authentication</span></tt></li>
<li><tt class="xref doc docutils literal"><span class="pre">/cookbook/testing/insulating_clients</span></tt></li>
<li><tt class="xref doc docutils literal"><span class="pre">/cookbook/testing/profiling</span></tt></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Testes</a><ul>
<li><a class="reference internal" href="#o-framework-de-testes-phpunit">O Framework de testes PHPUnit</a></li>
<li><a class="reference internal" href="#testes-unitarios">Testes Unitários</a></li>
<li><a class="reference internal" href="#testes-funcionais">Testes Funcionais</a><ul>
<li><a class="reference internal" href="#seu-primeiro-teste-funcional">Seu Primeiro Teste Funcional</a></li>
</ul>
</li>
<li><a class="reference internal" href="#trabalhando-com-o-teste-client">Trabalhando com o Teste Client</a><ul>
<li><a class="reference internal" href="#navegando">Navegando</a></li>
<li><a class="reference internal" href="#acessando-objetos-internos">Acessando Objetos Internos</a></li>
<li><a class="reference internal" href="#acessando-o-container">Acessando o Container</a></li>
<li><a class="reference internal" href="#acessando-dados-do-profiler">Acessando dados do Profiler</a></li>
<li><a class="reference internal" href="#redirecionamento">Redirecionamento</a></li>
</ul>
</li>
<li><a class="reference internal" href="#o-crawler">O Crawler</a><ul>
<li><a class="reference internal" href="#examinando">Examinando</a></li>
<li><a class="reference internal" href="#extraindo-informacoes">Extraindo Informações</a></li>
<li><a class="reference internal" href="#links">Links</a></li>
<li><a class="reference internal" href="#formularios">Formulários</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuracao-de-testes">Configuração de Testes</a><ul>
<li><a class="reference internal" href="#configuracao-do-phpunit">Configuração do PHPUnit</a></li>
</ul>
</li>
<li><a class="reference internal" href="#aprenda-mais-no-cookbook">Aprenda mais no Cookbook</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="doctrine.html"
                        title="previous chapter">Bancos de Dados e Doctrine</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="validation.html"
                        title="next chapter">Validação</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/book/testing.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="validation.html" title="Validação"
             >next</a> |</li>
        <li class="right" >
          <a href="doctrine.html" title="Bancos de Dados e Doctrine"
             >previous</a> |</li>
        <li><a href="../index.html">Symfony2.4Docs 2.4 documentation</a> &raquo;</li>
          <li><a href="index.html" >Livro</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Symfony Team + Symfony pt_BR Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>